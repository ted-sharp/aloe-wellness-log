# アロエ健康管理ログ 実装タスク一覧

**最終更新日:** 2025-07-21  
**プロジェクト状態:** 実装完了（PWAアプリとしてリリース済み）

<!-- cspell:words Flexbox -->

---

## ✅ 1. プロジェクトセットアップ - 完了

- [x] ✅ Vite + React + TypeScript プロジェクトの作成
- [x] ✅ 必要なパッケージのインストール（MobX, Tailwind CSS, Recharts, Headless UI等）
- [x] ✅ Tailwind CSS のセットアップ
- [x] ✅ プロジェクトのディレクトリ構成設計（Repository パターン含む）
- [x] ✅ PWA 設定（Service Worker, Manifest）

---

## ⚠️ 2. 設定ファイル（fields.json）対応 - 変更

**実装方針変更:** 外部設定ファイルではなく、固定の記録項目で実装

- [x] ✅ 体重記録機能（目標管理、BMI計算）
- [x] ✅ 血圧記録機能（最高・最低血圧、心拍数）
- [x] ✅ 日課記録機能（運動、食事、睡眠、喫煙、飲酒）
- [ ] 🔄 将来的なユーザーカスタマイズ対応

---

## ✅ 3. 型定義・データモデル設計 - 完了

- [x] ✅ 記録データ型定義（src/types/record.ts, goal.ts）
- [x] ✅ コンポーネント props 型定義（src/types/componentProps.ts）  
- [x] ✅ IndexedDB スキーマ設計（Repository パターン）

---

## ✅ 4. データストア・永続化 - 完了

- [x] ✅ MobX による状態管理ストアの実装（Zustandから移行完了）
  - [x] dateStore: 日付選択管理
  - [x] goalStore: 目標設定・追跡
  - [x] recordsStore: 健康記録CRUD
  - [x] toastStore: 通知システム
- [x] ✅ IndexedDB + Repository パターン実装
- [x] ✅ 記録データの保存・取得・削除・更新ロジック
- [x] ✅ エラーハンドリング（DbError 型）

---

## ✅ 5. UI 実装 - 完了

### 5.1 共通 - 完了
- [x] ✅ React Router による画面遷移
- [x] ✅ レスポンシブレイアウト（モバイルファースト）
- [x] ✅ Tailwind CSS による統一デザイン

### 5.2 実装済み画面一覧

**体重記録画面 (WeightRecord.tsx)**
- [x] ✅ 体重入力、目標設定、BMI計算
- [x] ✅ グラフ表示、進捗管理

**日課記録画面 (DailyRecord.tsx)**  
- [x] ✅ 運動、食事、睡眠、喫煙、飲酒の記録
- [x] ✅ カスタムフィールド追加機能

**血圧記録画面 (BpRecord.tsx)**
- [x] ✅ 最高・最低血圧、心拍数の記録

**グラフ表示画面 (RecordGraph.tsx)**
- [x] ✅ 時系列データのグラフ表示
- [x] ✅ 期間選択機能（1週間、2週間、1ヶ月、2ヶ月）

**目標設定画面 (GoalInput.tsx)**
- [x] ✅ 体重目標、個人情報の管理

**データ管理画面 (RecordExport.tsx)**
- [x] ✅ JSON形式でのデータエクスポート
- [x] ✅ テストデータ生成機能

### 完了済み実装

#### UI/UX 改善の実装

- [x] ボタンの視認性向上（背景色・アイコン・ホバー効果）
- [x] react-calendar のスタイル調整（日本式カレンダー色・今日の日付色）
- [x] CSS の競合解決（global vs Tailwind CSS）
- [x] 記録入力画面のレイアウト最適化（カードベース・サイズ統一）
- [x] 記録一覧画面のボタン配置問題解決（項目名長さによるガタガタ配置の修正）
- [x] エクスポート機能の専用画面分離と UI 簡素化
- [x] 記録一覧画面のカードデザイン統一（美しい UI 改善）
- [x] 記録入力画面の日時変更機能実装（過去・未来の記録対応）
- [x] 記録入力画面の備考・メモ機能実装（体調・状況記録対応）

#### データ永続化の実装

- [x] IndexedDB を使用したデータ永続化
- [x] 日付・時間の時差問題修正（toISOString→ ローカル時間ベース統一）✅ 2024-12-26

### 記録一覧画面のボタン配置改善（2025-06-18）

**問題**: 項目名の長さが異なるため、編集・削除ボタンの位置がガタガタになっていた

**解決策**: Flexbox の `justify-between` を使用した両端配置レイアウト

```jsx
<li className="border-b pb-1 flex items-center justify-between">
  <div className="flex items-center gap-2">
    <span className="font-bold">{項目名}:</span>
    <span>{値}</span>
  </div>
  <div className="flex gap-1">
    <button>✏️ 編集</button>
    <button>🗑️ 削除</button>
  </div>
</li>
```

**効果**:

- すべてのボタンが右端に整列
- 視覚的統一感の向上
- 使いやすさの向上

---

## ✅ 6. ユーザー体験向上 - 完了

- [x] ✅ 前回値の自動取得機能
- [x] ✅ 単位表示（kg, mmHg, bpm等）
- [x] ✅ Toast通知システム（保存成功・失敗）
- [ ] 🔄 ダークモード対応（将来実装予定）

---

## ✅ 7. データエクスポート - 完了

- [x] ✅ JSON形式でのデータエクスポート機能
- [x] ✅ ファイル名に日付自動追加
- [ ] ⚠️ CSV エクスポート（実装方針変更により削除）

---

## ✅ 8. テスト・品質保証 - 部分実装

- [x] ✅ ビジネスロジックのユニットテスト（hooks/business/__tests__/）
- [x] ✅ コンポーネントのユニットテスト（Button, ErrorBoundary等）
- [x] ✅ E2E テスト（Playwright）- 主要画面の表示テスト
- [x] ✅ TypeScript による型安全性

---

## ✅ 9. ドキュメント整備 - 完了

- [x] ✅ README.md の作成・更新（日本語）
- [x] ✅ CLAUDE.md（開発者向けガイド）
- [x] ✅ PWAインストールガイド

---

## ✅ 10. 機能拡張 - 実装済み

- [x] ✅ グラフ表示機能（Recharts）
- [x] ✅ 日付ピッカー（DatePickerBar）
- [ ] 🔄 カレンダー表示機能（将来実装予定）
- [ ] 🔄 データインポート機能（将来実装予定）
- [x] ✅ PWA対応・オフライン機能

## エクスポート画面（RecordExport.tsx）

- [x] 専用ページとして独立
- [x] シンプルなインターフェース
- [x] JSON・CSV 形式での出力

## 記録グラフ画面（RecordGraph.tsx）

- [x] 基本実装

## 記録カレンダー画面（RecordCalendar.tsx）

- [x] カレンダー表示
- [x] 日本風カスタマイズ（土曜青、日曜赤、今日緑）
- [x] データ保存・表示機能
- [x] タイムゾーン対応

## データ構造

- [x] Field 型に order 属性追加
- [x] 縦持ちスキーマ（fieldId-value 構造）
- [x] IndexedDB 永続化
- [x] **既存データマイグレーション機能** ✨
  - order マッピングによる正確な順序付与
  - loadFields 時の自動マイグレーション実行
- [x] **ブール値保存改善** ✨
  - 未設定 boolean 項目の false 値明示保存
  - 型安全なデータ処理

## 技術実装

- [x] TypeScript 対応
- [x] Tailwind CSS 統一デザイン
- [x] Zustand 状態管理
- [x] エラーハンドリング

## 🎉 主要機能完成

✅ **カスタム項目順序指定機能**
✅ **統一項目順序表示**
✅ **ブール値の適切な表示（あり/なし）**
✅ **美しい UI/UX デザイン**
✅ **データ永続化とマイグレーション**

## 今後の拡張可能性

- 既存項目への順序再設定機能
- データエクスポート時の順序統一
- グラフ機能の拡張
- より高度なフィルタリング・検索機能

### 完了したタスク ✅

### UI 統一性向上の実装 (2024 年 12 月)

**カレンダーページの記録表示改善**:

- 日付クリック時の記録表示をカード形式に変更
- 記録一覧と同じデザインで統一
- 時刻ごとのグループ化と項目順序制御を実装

**グラフページの項目順序修正**:

- グラフ画面の項目選択ドロップダウンを order 順でソート
- `./src/pages/RecordGraph.tsx`: numberFields 取得時にソート処理追加
- 全ページで項目表示順序を統一

### 初期項目設定の改善 (2024 年 12 月)

**変更内容**:

- 血圧項目を「収縮期血圧」と「拡張期血圧」に分離
- 心拍数項目を追加
- 体温項目を追加
- 項目順序を適切に調整

**新しい初期項目**:

1. 体重 (kg) - 数値
2. 収縮期血圧（最高血圧） (mmHg) - 数値
3. 拡張期血圧（最低血圧） (mmHg) - 数値
4. 心拍数 (bpm) - 数値
5. 体温 (℃) - 数値
6. 運動有無(通勤時の早歩き) - 有無
7. 食事有無(80kcal 減) - 有無
8. 睡眠有無(0 時までに寝る) - 有無

**実装箇所**: `./src/store/records.ts` の initialFields 配列

### IndexedDB の保存処理修正 (2024 年 12 月頃)

**問題**: 起動直後に昨日入力した内容が記録されていない
**原因**:

1. IndexedDB の`addRecord`で`store.add()`使用により、重複 ID でエラー発生
2. 同じ日時に記録すると同じ ID が生成される問題
3. エラーハンドリング不足

**修正内容**:

- `./src/db/indexedDb.ts`: `store.add()`を`store.put()`に変更
- `./src/pages/RecordInput.tsx`:
  - ID 生成に uniqueTimestamp を追加
  - try-catch 文でエラーハンドリング追加
  - TypeScript 型安全性向上（any 型除去）
- `./src/store/records.ts`: デバッグログ追加

**結果**: データ保存・読み込みの安定化を実現

## 今後の改善予定 📋

### 1. パフォーマンス最適化

- [ ] 大量データでの表示速度改善
- [ ] グラフ描画の最適化

### 2. ユーザビリティ向上

- [ ] オフライン対応強化
- [ ] データエクスポート機能強化

### 3. 保守性向上

- [ ] テストコード追加
- [ ] ドキュメント整備

## 技術的知見 🔧

### UI 設計の統一性

- 全ページで項目表示順序を order 属性で統一
- カード形式デザインの共通化により視認性向上
- 時刻グループ化による記録の整理表示

### 健康管理データの標準値

- **収縮期血圧**: 正常値 120mmHg 未満
- **拡張期血圧**: 正常値 80mmHg 未満
- **心拍数**: 安静時正常値 60-100bpm
- **体温**: 正常値 36.0-37.5℃

### IndexedDB 使用時の注意点

1. `store.add()`は重複 ID でエラー → `store.put()`で解決
2. ID 生成は一意性を保つため timestamp + unique suffix 推奨
3. エラーハンドリングは必須（特に DB 操作）

### TypeScript 型安全性

- `any`型使用を避け、適切な Union 型を使用
- HTMLinput 要素の value 属性は boolean 型を受け取れない点に注意

### 時差問題の解決 (2024 年 12 月 26 日) ✅

**問題**: カレンダー表示で記録が正しく表示されない
**原因**: 記録保存時に UTC 時間、表示時にローカル時間を使用する不整合

**修正内容**:

- **RecordInput.tsx**: ローカル時間フォーマット関数を追加
  - `formatLocalDate()`: ローカル日付を YYYY-MM-DD 形式で生成
  - `formatLocalTime()`: ローカル時刻を HH:MM 形式で生成
  - `formatLocalDateTime()`: ローカル日時を ISO 形式で生成
  - `toISOString()`を全て手動フォーマットに置換
- **RecordInput.test.tsx**: テストも同様にローカル時間ベースに修正
- **RecordExport.tsx**: エクスポート機能のファイル名生成とテストデータ生成を修正
- **main.tsx**: ログ出力用 timestamp 修正

**効果**:

- カレンダー表示で記録が正確に表示される
- 時差に関係なく一貫した日時処理を実現
- ユーザーが記録した日付に正しくデータが表示される

**技術的詳細**:

```typescript
// 修正前（UTC時間）
datetime: selectedDateTime.toISOString();

// 修正後（ローカル時間）
datetime: formatLocalDateTime(selectedDateTime);
```
