import{j as e}from"./ui-vendor-BuGzxEnB.js";import{u as t,C as a,a as s,b as l,D as i,c as n,S as d,v as r,d as o,P as c}from"./dnd-vendor-B-r8cpST.js";import{a as u}from"./react-vendor-9hcqHTTy.js";import{G as m}from"./icons-vendor-BLJDdPqg.js";import{a as f,f as x,h as g,i as p,j as h,k as y,l as b,m as v,n as w,o as j,p as k,q as I,r as D,H as N,s as C,t as S,v as E,w as F}from"./index-D0hqXwCf.js";import{B as A}from"./Button-Dy_TAhW8.js";import{u as z,D as R}from"./useDateSelection-Oqi_uXyt.js";import"./state-vendor-DgseLVVv.js";function $(e){return m({attr:{viewBox:"0 0 384 512"},child:[{tag:"path",attr:{d:"M216 23.86c0-23.8-30.65-32.77-44.15-13.04C48 191.85 224 200 224 288c0 35.63-29.11 64.46-64.85 63.99-35.17-.45-63.15-29.77-63.15-64.94v-85.51c0-21.7-26.47-32.23-41.43-16.5C27.8 213.16 0 261.33 0 320c0 105.87 86.13 192 192 192s192-86.13 192-192c0-170.29-168-193-168-296.14z"},child:[]}]})(e)}function W(e,t=800){const[a,s]=u.useState(0);return u.useEffect(()=>{if("number"!=typeof e||isNaN(e))return;const a=performance.now();requestAnimationFrame(function l(i){const n=i-a,d=Math.min(n/t,1);s(0+(e-0)*d),d<1?requestAnimationFrame(l):s(e)})},[e,t]),a}const B=u.memo(function({field:t,value:a,stats:s,onAchieve:l,onPartial:i,onUnachieve:n}){const d=W(s.percent);return e.jsxs("div",{className:"flex flex-col gap-1 bg-white dark:bg-gray-800 rounded-xl shadow p-4 mb-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-lg font-semibold text-gray-700 dark:text-gray-200 min-w-[5em]",children:t.name}),e.jsx(A,{variant:1===a?"primary":"secondary",size:"md",onClick:l,"aria-pressed":1===a,className:"flex-1","data-testid":`daily-input-${t.fieldId}-achieve`,children:"達成"}),e.jsx(A,{variant:.5===a?"primary":"secondary",size:"md",onClick:i,"aria-pressed":.5===a,className:"flex-1","data-testid":`daily-input-${t.fieldId}-partial`,children:"微達成"}),e.jsx(A,{variant:0===a?"primary":"secondary",size:"md",onClick:n,"aria-pressed":0===a,className:"flex-1","data-testid":`daily-input-${t.fieldId}-unachieve`,children:"未達"})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[e.jsx("span",{className:"text-base font-semibold text-blue-700 dark:text-blue-200 align-middle",children:"直近2週間の達成率："}),s.total>0?e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"ml-4 text-base font-semibold text-blue-700 dark:text-blue-200 align-middle",children:[e.jsx("span",{style:{display:"inline-block",minWidth:"3ch",textAlign:"right",fontFamily:"monospace"},children:d.toFixed(0)}),"%"]}),e.jsxs("span",{className:"ml-2 text-base font-semibold text-blue-700 dark:text-blue-200 align-middle",children:["(",s.success,"/",s.total,"日)"]})]}):"記録なし"]})]})}),M=u.memo(function({field:s,isEditing:l,onStartEdit:i,onEndEdit:n,onNameChange:d,onDelete:r,onToggleDisplay:o,inputRef:c,onCaretPositionChange:m}){const{attributes:h,listeners:y,setNodeRef:b,transform:v,transition:w,isDragging:j}=t({id:s.fieldId}),k={...j?{transform:a.Transform.toString(v),transition:w}:{},opacity:j?.5:1,background:j?"#f3f4f6":void 0},[I,D]=u.useState(s.name);u.useEffect(()=>{l&&D(s.name)},[l,s.name]);return e.jsxs("div",{ref:b,style:k,className:"flex items-center gap-2 rounded-xl shadow p-4 mb-2 transition-colors "+(!1===s.display?"bg-gray-100 dark:bg-gray-700 text-gray-400":"bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200"),children:[l?e.jsx("input",{ref:c,type:"text",value:I,onChange:e=>{D(e.target.value);const t=e.target.selectionStart??e.target.value.length,a=e.target.selectionEnd??e.target.value.length;null==m||m(s.fieldId,t,a)},onSelect:e=>{const t=e.target,a=t.selectionStart??t.value.length,l=t.selectionEnd??t.value.length;null==m||m(s.fieldId,a,l)},onBlur:()=>{d(I),n()},onKeyDown:e=>{"Enter"===e.key&&(d(I),n())},className:"flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400 text-lg font-semibold min-w-[5em] bg-inherit "+(!1===s.display?"border-gray-200 dark:border-gray-600 text-gray-400 bg-gray-50 dark:bg-gray-800":"border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200"),"data-testid":`daily-input-${s.fieldId}`}):e.jsx("span",{className:"flex-1 text-lg font-semibold min-w-[5em] cursor-pointer",onClick:i,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||i()},role:"button","aria-label":"項目名を編集",tabIndex:0,children:s.name}),e.jsx("button",{type:"button",onClick:()=>{window.confirm("本当に削除しますか？\n（保存すると確定されます。）")&&r()},className:"text-red-500 hover:text-red-700 p-2","aria-label":"削除","data-testid":`delete-btn-${s.fieldId}`,children:e.jsx(f,{className:"w-6 h-6"})}),e.jsx("button",{type:"button",onClick:o,className:"p-2 "+(!1===s.display?"text-gray-400 hover:text-blue-400":"text-blue-500 hover:text-blue-700"),"aria-label":!1===s.display?"表示項目にする":"非表示項目にする","data-testid":`toggle-btn-${s.fieldId}`,children:!1===s.display?e.jsx(x,{className:"w-6 h-6"}):e.jsx(g,{className:"w-6 h-6"})}),e.jsx("span",{className:"cursor-move p-2","aria-label":"並び替えハンドル",style:{touchAction:"none"},...h,...y,tabIndex:0,children:e.jsx(p,{className:"w-6 h-6 text-gray-400"})})]})}),P=()=>{const{fields:t,records:a,getAchievementValue:m,isRecorded:f,handleAchievementInput:x,addField:g,deleteField:p,updateField:P,getFieldSuccessStats:T,calcStreak:q,calcTotalAchievedDays:K,getDateStatus:O,getDisplayFields:U}=(()=>{const[e,t]=u.useState([]),[a,s]=u.useState([]),l=[{fieldId:"exercise",name:"運動",order:10,display:!0},{fieldId:"meal",name:"食事",order:20,display:!0},{fieldId:"sleep",name:"睡眠",order:30,display:!0},{fieldId:"smoke",name:"喫煙",order:40,display:!1},{fieldId:"alcohol",name:"飲酒",order:50,display:!1}],i=u.useCallback(async()=>{const e=await h();t(e)},[]),n=u.useCallback(async()=>{const e=await y();s(e)},[]);u.useEffect(()=>{(async()=>{const e=await h();if(!e||0===e.length){for(const e of l)await b(e);t(await h())}})()},[]),u.useEffect(()=>{i(),n()},[i,n]);const d=u.useCallback((e,t)=>a.find(a=>a.fieldId===e&&a.date===t),[a]),r=u.useCallback((e,t)=>{const a=d(e,t);if("number"==typeof(null==a?void 0:a.value)){if(1===a.value)return 1;if(.5===a.value)return.5;if(0===a.value)return 0}},[d]),o=u.useCallback(t=>{const s=v(t),l=e.map(e=>e.fieldId);return a.some(e=>e.date===s&&l.includes(e.fieldId))},[e,a]),c=u.useCallback(async(e,t,a)=>{const s=d(e,a);if(s&&s.value===t)await w(s.id),await n();else if(s)await j({...s,value:t}),await n();else{const s=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;await k({id:s,fieldId:e,date:a,value:t}),await n()}},[d,n]),m=u.useCallback(async t=>{if(!t.trim())throw new Error("項目名を入力してください");if(e.some(e=>e.name===t))throw new Error("同じ名前の項目が既に存在します");const a={fieldId:`custom_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,name:t,order:10*(e.length+1),display:!0};return await b(a),await i(),a},[e,i]),f=u.useCallback(async e=>{await I(e),await i()},[i]),x=u.useCallback(async e=>{await D(e),await i()},[i]),g=u.useCallback(()=>{const e=new Date,t=[];for(let a=0;a<14;a++){const s=new Date(e);s.setDate(e.getDate()-a),t.push(v(s))}return t.reverse()},[]),p=u.useCallback(e=>{const t=g();let s=0,l=0;return t.forEach(t=>{const i=a.find(a=>a.fieldId===e&&a.date===t);"number"==typeof(null==i?void 0:i.value)&&(s++,i.value>0&&l++)}),{total:s,success:l,percent:s>0?Math.round(l/s*100):0}},[a,g]),N=u.useCallback(t=>{if(0===a.length)return 0;const s=e.map(e=>e.fieldId),l=a.map(e=>e.date).sort();if(0===l.length)return 0;const i=new Date(l[0]);let n=0;for(let e=new Date(t);e>=i;e.setDate(e.getDate()-1)){const t=v(e);if(!s.some(e=>a.some(a=>a.fieldId===e&&a.date===t&&"number"==typeof a.value&&a.value>0)))break;n++}return n>1?n:0},[a,e]),C=u.useCallback(t=>{const s=e.map(e=>e.fieldId);if(0===a.length)return 0;const l=a.map(e=>e.date).sort(),i=new Date(l[0]),n=t;let d=0;for(let e=new Date(i);e<=n;e.setDate(e.getDate()+1)){const t=v(e);s.some(e=>a.some(a=>a.fieldId===e&&a.date===t&&"number"==typeof a.value&&a.value>0))&&d++}return d},[a,e]),S=u.useCallback(t=>{const s=v(t),l=e.map(e=>e.fieldId),i=a.filter(e=>e.date===s&&l.includes(e.fieldId));return 0===i.length?"none":i.some(e=>1===e.value||.5===e.value)?"green":"red"},[a,e]),E=u.useCallback((t,s)=>t?e.slice().sort((e,t)=>(e.order??0)-(t.order??0)):e.filter(e=>"display"in e&&!1!==e.display||(s?a.some(t=>t.fieldId===e.fieldId&&t.date===s&&null!==t.value&&void 0!==t.value):a.some(t=>t.fieldId===e.fieldId&&null!==t.value&&void 0!==t.value))).sort((e,t)=>(e.order??0)-(t.order??0)),[e,a]);return{fields:e,records:a,loadFields:i,loadRecords:n,getBoolRecord:d,getAchievementValue:r,isRecorded:o,handleAchievementInput:c,addField:m,deleteField:f,updateField:x,getFieldSuccessStats:p,calcStreak:N,calcTotalAchievedDays:C,getDateStatus:S,getDisplayFields:E}})(),{selectedDate:V,setSelectedDate:_,centerDate:G,setCenterDate:H,recordDate:L}=z({records:a,getRecordDate:e=>e.date}),[J,Q]=u.useState(!1),[X,Y]=u.useState(""),[Z,ee]=u.useState(""),[te,ae]=u.useState(!1),se=U(te,L),[le,ie]=u.useState([]),[ne,de]=u.useState(()=>se.map(e=>e.fieldId)),[re,oe]=u.useState([]),ce=s(l(c));u.useEffect(()=>{if(te){const e=t.slice().sort((e,t)=>(e.order??0)-(t.order??0));ie(e.map(e=>({fieldId:e.fieldId,name:e.name,order:e.order??0,display:"display"in e?e.display:"boolean"!=typeof e.defaultDisplay||e.defaultDisplay}))),de(e.map(e=>e.fieldId)),oe([])}},[te,t]);const[ue,me]=u.useState(null),fe=u.useRef({}),xe=u.useRef({});u.useEffect(()=>{if(!ue)return;const e=fe.current[ue];if(e){const t=xe.current[ue]??{start:e.value.length,end:e.value.length};e.setSelectionRange(t.start,t.end)}},[ue]);const ge=u.useCallback((e,t,a)=>{xe.current[e]={start:t,end:a}},[]),pe=u.useCallback(e=>{oe(t=>[...t,e]),ie(t=>t.filter(t=>t.fieldId!==e)),de(t=>t.filter(t=>t!==e))},[]),he=u.useCallback(e=>{ie(t=>t.map(t=>t.fieldId===e?{...t,display:!t.display}:t))},[]),ye=q(V),be=W(ye),ve=W(K(V));return e.jsxs("div",{className:"bg-transparent",children:[e.jsx(R,{selectedDate:V,setSelectedDate:_,centerDate:G,setCenterDate:H,getDateStatus:O,"data-testid":"date-picker"}),e.jsx("div",{className:"w-full max-w-md mx-auto mt-3 mb-3 flex justify-start pl-4",children:e.jsxs("span",{className:"text-lg sm:text-xl font-bold text-gray-800 dark:text-white",children:[L,f(V)&&e.jsx(N,{className:"inline-block w-6 h-6 text-green-500 ml-2 align-middle","aria-label":"入力済み"}),e.jsxs("span",{className:"inline-flex items-center",children:[ye>=2&&e.jsxs("span",{className:"ml-3 px-2 py-0.5 rounded-full bg-orange-500 text-white text-xs font-bold inline-flex items-center",title:"連続達成日数",children:[e.jsx($,{className:"inline-block mr-1",style:{fontSize:"1em"}}),e.jsx("span",{style:{display:"inline-block",minWidth:"3ch",textAlign:"right"},children:be.toFixed(0)}),"日継続中"]}),e.jsxs("span",{className:"ml-3 px-2 py-0.5 rounded-full bg-blue-500 text-white text-xs font-bold inline-flex items-center",title:"累計達成日数",children:[e.jsx("span",{className:"inline-block mr-1",style:{fontSize:"1em"},children:"🏅"}),e.jsx("span",{style:{display:"inline-block",minWidth:"3ch",textAlign:"right"},children:ve.toFixed(0)}),"日達成"]})]})]})}),e.jsxs("div",{className:"flex flex-col items-center justify-start min-h-[60vh]",children:[e.jsx("div",{className:"flex flex-col gap-1 w-full max-w-md",children:te?e.jsx(i,{sensors:ce,collisionDetection:n,onDragEnd:e=>{const{active:t,over:a}=e;if(!a)return;const s=String(t.id),l=String(a.id);if(s!==l){const e=ne.indexOf(s),t=ne.indexOf(l);de(o(ne,e,t))}},children:e.jsx(d,{items:ne,strategy:r,children:ne.map(t=>{const a=le.find(e=>e.fieldId===t);if(!a)return null;const s=ue===a.fieldId;return e.jsx(M,{field:a,isEditing:s,onStartEdit:()=>me(a.fieldId),onEndEdit:()=>me(null),onNameChange:e=>ie(t=>t.map(t=>t.fieldId===a.fieldId?{...t,name:e}:t)),onDelete:()=>pe(a.fieldId),onToggleDisplay:()=>he(a.fieldId),inputRef:e=>fe.current[a.fieldId]=e,onCaretPositionChange:ge},a.fieldId)})})}):se.map(t=>{const a=m(t.fieldId,L),s=T(t.fieldId);return e.jsx(B,{field:t,value:a,stats:s,onAchieve:async()=>{await x(t.fieldId,1,L)},onPartial:async()=>{await x(t.fieldId,.5,L)},onUnachieve:async()=>{await x(t.fieldId,0,L)}},t.fieldId)})}),te&&e.jsxs("div",{className:"w-full max-w-md mt-2 mb-2",children:[J?e.jsxs("div",{className:"flex items-center gap-1 mb-1 bg-white dark:bg-gray-800 rounded-xl shadow p-2",children:[e.jsx("input",{type:"text",value:X,onChange:e=>Y(e.target.value),className:"flex-1 border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400",placeholder:"新しい項目名",maxLength:20,"data-testid":"daily-input-2"}),e.jsx(A,{variant:"primary",size:"md",icon:N,"aria-label":"保存",onClick:async()=>{ee("");try{const e=await g(X);te&&(ie(t=>[...t,e]),de(t=>[...t,e.fieldId])),Q(!1),Y("")}catch(e){ee(e instanceof Error?e.message:"エラーが発生しました")}},disabled:!X.trim(),"data-testid":"save-btn",children:""}),e.jsx(A,{variant:"secondary",size:"md",icon:C,"aria-label":"キャンセル",onClick:()=>{Q(!1),Y(""),ee("")},children:""})]}):e.jsx(A,{variant:"teal",size:"md",icon:S,fullWidth:!0,onClick:()=>Q(!0),"data-testid":"add-btn",children:"新規項目"}),Z&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:Z})]}),e.jsx("div",{className:"w-full max-w-md mt-2 mb-2",children:te?e.jsxs("div",{className:"flex gap-1",children:[e.jsx(A,{variant:"success",size:"md",icon:E,onClick:async()=>{for(const e of re)await p(e);for(let e=0;e<ne.length;++e){const t=le.find(t=>t.fieldId===ne[e]);t&&await P({...t,order:10*e})}ae(!1)},fullWidth:!0,children:"保存"}),e.jsx(A,{variant:"secondary",size:"md",icon:C,onClick:()=>{ae(!1)},fullWidth:!0,children:"キャンセル"})]}):e.jsx(A,{variant:"teal",size:"md",icon:F,fullWidth:!0,onClick:()=>ae(!0),children:"編集"})}),e.jsx("div",{className:"w-full max-w-md mx-auto mb-2 px-4",children:e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900 border-l-4 border-yellow-400 text-yellow-800 dark:text-yellow-100 p-3 rounded shadow-sm text-sm text-left",children:[e.jsx("strong",{children:"【ワンポイント】"})," ","日課は毎日少しずつでも続けることが大切です。完璧を目指さず、できた日を積み重ねましょう。少しでもやったら微達成として記録しましょう。"]})})]})]})};export{P as default};
