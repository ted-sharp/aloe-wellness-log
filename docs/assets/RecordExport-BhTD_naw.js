import{j as e}from"./ui-vendor-Z70llhoy.js";import{a as t}from"./react-vendor-DRLO6cO2.js";import{E as r,F as a,y as s,h as l,u as o,k as n,p as i,G as d,I as c,H as x,m,B as p,J as u,K as g,r as f,t as h}from"./index-BNZho4P3.js";import"./icons-vendor-DbsR8xvJ.js";import"./state-vendor-Crk1RRDk.js";const b={success:{containerClass:"bg-green-50 border-green-200 text-green-700",iconClass:"text-green-600",defaultIcon:l},error:{containerClass:"bg-red-50 border-red-200 text-red-700",iconClass:"text-red-600",defaultIcon:s},warning:{containerClass:"bg-amber-50 border-amber-200 text-amber-700",iconClass:"text-amber-600",defaultIcon:a},info:{containerClass:"bg-blue-50 border-blue-200 text-blue-700",iconClass:"text-blue-600",defaultIcon:r}},j="p-4 rounded-lg border font-medium flex items-start gap-3 shadow-sm",w=({type:r,message:a,autoHide:s=!1,hideDelay:l=3e3,onHide:o,className:n="",icon:i})=>{const[d,c]=t.useState(!0),x=b[r],m=i||x.defaultIcon;if(t.useEffect(()=>{if(s&&l>0){const e=setTimeout(()=>{c(!1),null==o||o()},l);return()=>clearTimeout(e)}},[s,l,o]),!d)return null;const p=[j,x.containerClass,n].join(" ");return e.jsxs("div",{className:p,role:"alert","aria-live":"polite",children:[e.jsx(m,{className:`w-5 h-5 ${x.iconClass} flex-shrink-0 mt-0.5`,"aria-hidden":"true"}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"text-sm leading-relaxed",children:a})})]})},v=t=>e.jsx(w,{type:"success",...t}),N=t=>e.jsx(w,{type:"error",...t}),y=t=>e.jsx(w,{type:"info",...t});function k(e){return`${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}${String(e.getHours()).padStart(2,"0")}${String(e.getMinutes()).padStart(2,"0")}${String(e.getSeconds()).padStart(2,"0")}`}function S(){var r,s;const{t:l}=o(),{records:b,fields:j,loadRecords:w,loadFields:S,deleteAllData:$,initializeFields:E,addRecord:C}=n(),[D,R]=t.useState(null),[I,O]=t.useState(null),[F,A]=t.useState(0),[L,U]=t.useState(!1),[H,J]=t.useState(null);if(H)throw H;t.useEffect(()=>(i.trackRender.start("RecordExport"),()=>{i.trackRender.end("RecordExport")})),t.useEffect(()=>{(async()=>{try{await h("load-fields-export",async e=>{await S()}),await h("load-records-export",async e=>{await w()})}catch(e){console.error("Data loading error:",e)}})()},[S,w]),t.useEffect(()=>{},[b.length,j.length,D,I,F,L]);const T=(()=>{performance.now();const e=[...b].sort((e,t)=>{const r=`${e.date} ${e.time}`;return`${t.date} ${t.time}`.localeCompare(r)});return performance.now(),e})(),W=async(e,t)=>{R(l("pages.export.importing"));try{const a=await e.text();let s;if("json"===t){if(s=JSON.parse(a),!Array.isArray(s))throw new Error("JSON file format is incorrect")}else s=(e=>{const t=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").trim().split("\n");if(t.length<2)throw new Error("CSVファイルが空または形式が正しくありません");const r=e=>{const t=[];let r="",a=!1,s=0;for(;s<e.length;){const l=e[s];'"'===l?a&&'"'===e[s+1]?(r+='"',s+=2):(a=!a,s++):","!==l||a?(r+=l,s++):(t.push(r),r="",s++)}return t.push(r),t},a=r(t[0]),s=["id","date","time","datetime","fieldId","fieldName","value"];if(!s.every(e=>a.includes(e)))throw console.error("Expected headers:",s),console.error("Actual headers:",a),new Error(`CSV file format is incorrect. Required columns: ${s.join(", ")}`);const o=[];for(let i=1;i<t.length;i++)try{if(!t[i].trim())continue;const e=r(t[i]);if(e.length!==a.length){a.length,e.length;continue}const s={id:e[a.indexOf("id")],date:e[a.indexOf("date")],time:e[a.indexOf("time")],datetime:e[a.indexOf("datetime")],fieldId:e[a.indexOf("fieldId")],value:e[a.indexOf("value")]};if(!(s.id&&s.date&&s.time&&s.fieldId))continue;s.value===l("fields.yes")||"あり"===s.value?s.value=!0:s.value===l("fields.no")||"なし"===s.value?s.value=!1:isNaN(Number(s.value))||""===s.value||(s.value=Number(s.value)),o.push(s)}catch(n){throw console.error(`Row ${i} parsing error:`,n),new Error(`${i}行目の処理でエラーが発生しました: ${n instanceof Error?n.message:"不明なエラー"}`)}return o})(a);for(const e of s)if(!(e.id&&e.date&&e.time&&e.fieldId))throw new Error("Data is missing required fields");let o=0;for(const e of s)try{await C(e),o++}catch(r){e.id}await w(),R(`✅ ${o}${l("pages.export.importSuccess")}`),setTimeout(()=>R(null),3e3)}catch(r){const e=r instanceof Error?r:new Error("Unknown error");console.error("Import error:",e),R(`${l("pages.export.importError")} ${e.message}`),setTimeout(()=>R(null),5e3)}};return e.jsxs("div",{className:"max-w-full sm:max-w-4xl mx-auto px-2 sm:px-0",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800 dark:text-white mb-12",children:l("pages.export.title")}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 mb-8",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-800 dark:text-white mb-6",children:l("pages.export.dataDetails")}),e.jsxs("div",{className:"text-base text-gray-600 dark:text-gray-300 space-y-3",children:[e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(c,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),e.jsx("strong",{className:"text-gray-800 dark:text-white",children:l("pages.export.totalRecords")})," ",T.length]}),e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(x,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),e.jsx("strong",{className:"text-gray-800 dark:text-white",children:l("pages.export.period")})," ",T.length>0?`${null==(r=T[T.length-1])?void 0:r.date} 〜 ${null==(s=T[0])?void 0:s.date}`:l("pages.export.noData")]}),e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(m,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),e.jsx("strong",{className:"text-gray-800 dark:text-white",children:l("pages.export.fields")})," ",l("pages.export.allHealthFields")]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 mb-8",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-800 dark:text-white mb-6",children:l("pages.export.exportData")}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300 mb-6",children:l("pages.export.exportDescription")}),e.jsxs("div",{className:"flex flex-col gap-4 mb-6",children:[e.jsx(p,{variant:"purple",size:"lg",icon:u,onClick:()=>{const e=function(e,t,r){return[["id","date","time","datetime","fieldId","fieldName","value"],...e.map(e=>{const a=t.find(t=>t.fieldId===e.fieldId);return[e.id,e.date,e.time,e.datetime,e.fieldId,a?a.name:"","boolean"==typeof e.value?e.value?r("fields.yes"):r("fields.no"):e.value]})].map(e=>e.map(String).map(e=>`"${e.replace(/"/g,'""')}"`).join(",")).join("\r\n")}(T,j,l),t=new Blob([e],{type:"text/csv"}),r=URL.createObjectURL(t),a=document.createElement("a");a.href=r,a.download=`records-${k(new Date)}.csv`,a.click(),URL.revokeObjectURL(r)},fullWidth:!1,children:l("pages.export.exportCSV")}),e.jsx(p,{variant:"purple",size:"lg",icon:u,onClick:()=>{const e=JSON.stringify(T,null,2),t=new Blob([e],{type:"application/json"}),r=URL.createObjectURL(t),a=document.createElement("a");a.href=r,a.download=`records-${k(new Date)}.json`,a.click(),URL.revokeObjectURL(r)},fullWidth:!1,children:l("pages.export.exportJSON")})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 mb-8",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-800 dark:text-white mb-6",children:l("pages.export.importData")}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300 mb-6",children:l("pages.export.importDescription")}),D&&e.jsxs("div",{className:"mb-6",children:[D.includes("✅")&&e.jsx(v,{message:D.replace("✅ ","")}),D.includes("❌")&&e.jsx(N,{message:D.replace("❌ ","")}),!D.includes("✅")&&!D.includes("❌")&&e.jsx(y,{message:D})]}),e.jsx("div",{className:"flex flex-col gap-4 mb-6",children:e.jsxs("div",{children:[e.jsx("input",{type:"file",accept:".csv,.json",onChange:e=>{var t;const r=null==(t=e.target.files)?void 0:t[0];if(r){const t=r.name.toLowerCase();let a;if(t.endsWith(".csv"))a="csv";else{if(!t.endsWith(".json"))return R(l("pages.export.unsupportedFileFormat")),setTimeout(()=>R(null),3e3),void(e.target.value="");a="json"}W(r,a)}e.target.value=""},className:"hidden",id:"data-import"}),e.jsxs("label",{htmlFor:"data-import",className:"bg-purple-600 text-white px-6 py-3 rounded-lg font-medium shadow-md hover:bg-purple-700 hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2 w-auto cursor-pointer",children:[e.jsx(g,{className:"w-5 h-5"}),l("pages.export.selectFile")]})]})})]}),d,d,e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-2xl shadow-md p-6",children:[e.jsxs("h2",{className:"text-2xl font-semibold text-red-800 dark:text-red-400 mb-6 flex items-center gap-2",children:[e.jsx(a,{className:"w-6 h-6 text-red-600 dark:text-red-500"}),l("pages.export.dangerZone")]}),e.jsx("div",{className:"mb-6 text-left",children:e.jsx("p",{className:"text-base text-red-700 dark:text-red-300 mb-3",children:l("pages.export.dangerZoneDescription")})}),e.jsx(p,{variant:"danger",size:"lg",icon:f,onClick:async()=>{if(window.confirm(l("pages.export.confirmDeleteAll"))){if(window.confirm(l("pages.export.confirmDeleteAllFinal")))try{await $(),await E(),alert(l("pages.export.deleteAllSuccess"))}catch(e){console.error("Delete error:",e),alert(l("pages.export.deleteAllError"))}}},fullWidth:!1,children:l("pages.export.deleteAllData")})]})]})}export{S as default};
//# sourceMappingURL=RecordExport-BhTD_naw.js.map
