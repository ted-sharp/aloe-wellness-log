import{j as e}from"./ui-vendor-J9A7wRLG.js";import{u as t,C as a,a as s,b as l,D as i,c as n,S as d,v as r,d as o,P as c}from"./dnd-vendor-BoAXorNb.js";import{a as u}from"./react-vendor-C4GzcRrE.js";import{G as m}from"./icons-vendor-DCv9Y2bB.js";import{b as f,i as x,j as g,k as p,l as h,m as y,n as b,o as v,p as w,q as j,r as k,s as I,t as D,u as C,a as N,H as S,v as E,w as F,x as A,y as z}from"./index-iR6G4H9o.js";import{B as R}from"./Button-DQwbRege.js";import{u as $,D as W}from"./useDateSelection-BcjXoyqX.js";import{u as B}from"./useSaveState-DbkjJmWD.js";import"./state-vendor-RA6ewXRt.js";function M(e){return m({attr:{viewBox:"0 0 384 512"},child:[{tag:"path",attr:{d:"M216 23.86c0-23.8-30.65-32.77-44.15-13.04C48 191.85 224 200 224 288c0 35.63-29.11 64.46-64.85 63.99-35.17-.45-63.15-29.77-63.15-64.94v-85.51c0-21.7-26.47-32.23-41.43-16.5C27.8 213.16 0 261.33 0 320c0 105.87 86.13 192 192 192s192-86.13 192-192c0-170.29-168-193-168-296.14z"},child:[]}]})(e)}function P(e,t=800){const[a,s]=u.useState(0);return u.useEffect(()=>{if("number"!=typeof e||isNaN(e))return;const a=performance.now();requestAnimationFrame(function l(i){const n=i-a,d=Math.min(n/t,1);s(0+(e-0)*d),d<1?requestAnimationFrame(l):s(e)})},[e,t]),a}const T=u.memo(function({field:t,value:a,stats:s,onAchieve:l,onPartial:i,onUnachieve:n}){const d=P(s.percent);return e.jsxs("div",{className:"flex flex-col gap-1 bg-white dark:bg-gray-800 rounded-xl shadow p-4 mb-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-lg font-semibold text-gray-700 dark:text-gray-200 min-w-[5em]",children:t.name}),e.jsx(R,{variant:1===a?"primary":"secondary",size:"md",onClick:l,"aria-pressed":1===a,className:"flex-1","data-testid":`daily-input-${t.fieldId}-achieve`,children:"達成"}),e.jsx(R,{variant:.5===a?"primary":"secondary",size:"md",onClick:i,"aria-pressed":.5===a,className:"flex-1","data-testid":`daily-input-${t.fieldId}-partial`,children:"微達成"}),e.jsx(R,{variant:0===a?"primary":"secondary",size:"md",onClick:n,"aria-pressed":0===a,className:"flex-1","data-testid":`daily-input-${t.fieldId}-unachieve`,children:"未達"})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[e.jsx("span",{className:"text-base font-semibold text-blue-700 dark:text-blue-200 align-middle",children:"直近2週間の達成率："}),s.total>0?e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"ml-4 text-base font-semibold text-blue-700 dark:text-blue-200 align-middle",children:[e.jsx("span",{style:{display:"inline-block",minWidth:"3ch",textAlign:"right",fontFamily:"monospace"},children:d.toFixed(0)}),"%"]}),e.jsxs("span",{className:"ml-2 text-base font-semibold text-blue-700 dark:text-blue-200 align-middle",children:["(",s.success,"/",s.total,"日)"]})]}):"記録なし"]})]})}),q=u.memo(function({field:s,isEditing:l,onStartEdit:i,onEndEdit:n,onNameChange:d,onDelete:r,onToggleDisplay:o,inputRef:c,onCaretPositionChange:m}){const{attributes:h,listeners:y,setNodeRef:b,transform:v,transition:w,isDragging:j}=t({id:s.fieldId}),k={...j?{transform:a.Transform.toString(v),transition:w}:{},opacity:j?.5:1,background:j?"#f3f4f6":void 0},[I,D]=u.useState(s.name);u.useEffect(()=>{l&&D(s.name)},[l,s.name]);return e.jsxs("div",{ref:b,style:k,className:"flex items-center gap-2 rounded-xl shadow p-4 mb-2 transition-colors "+(!1===s.display?"bg-gray-100 dark:bg-gray-700 text-gray-400":"bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200"),children:[l?e.jsx("input",{ref:c,type:"text",value:I,onChange:e=>{D(e.target.value);const t=e.target.selectionStart??e.target.value.length,a=e.target.selectionEnd??e.target.value.length;null==m||m(s.fieldId,t,a)},onSelect:e=>{const t=e.target,a=t.selectionStart??t.value.length,l=t.selectionEnd??t.value.length;null==m||m(s.fieldId,a,l)},onBlur:()=>{d(I),n()},onKeyDown:e=>{"Enter"===e.key&&(d(I),n())},className:"flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400 text-lg font-semibold min-w-[5em] bg-inherit "+(!1===s.display?"border-gray-200 dark:border-gray-600 text-gray-400 bg-gray-50 dark:bg-gray-800":"border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200"),"data-testid":`daily-input-${s.fieldId}`}):e.jsx("span",{className:"flex-1 text-lg font-semibold min-w-[5em] cursor-pointer",onClick:i,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||i()},role:"button","aria-label":"項目名を編集",tabIndex:0,children:s.name}),e.jsx("button",{type:"button",onClick:()=>{window.confirm("本当に削除しますか？\n（保存すると確定されます。）")&&r()},className:"text-red-500 hover:text-red-700 p-2","aria-label":"削除","data-testid":`delete-btn-${s.fieldId}`,children:e.jsx(f,{className:"w-6 h-6"})}),e.jsx("button",{type:"button",onClick:o,className:"p-2 "+(!1===s.display?"text-gray-400 hover:text-blue-400":"text-blue-500 hover:text-blue-700"),"aria-label":!1===s.display?"表示項目にする":"非表示項目にする","data-testid":`toggle-btn-${s.fieldId}`,children:!1===s.display?e.jsx(x,{className:"w-6 h-6"}):e.jsx(g,{className:"w-6 h-6"})}),e.jsx("span",{className:"cursor-move p-2","aria-label":"並び替えハンドル",style:{touchAction:"none"},...h,...y,tabIndex:0,children:e.jsx(p,{className:"w-6 h-6 text-gray-400"})})]})}),O=()=>{const{checkpointDates:t}=C(),a=N(),{saveState:m,executeSave:f}=B({onSuccess:()=>{a.showSuccess("編集を保存しました！")},onError:e=>{a.showError(`保存に失敗しました: ${e.message}`)}}),{fields:x,records:g,getAchievementValue:p,isRecorded:O,handleAchievementInput:K,addField:U,deleteField:V,updateField:_,getFieldSuccessStats:G,calcStreak:H,calcTotalAchievedDays:L,getDateStatus:J,getDisplayFields:Q}=(()=>{const[e,t]=u.useState([]),[a,s]=u.useState([]),l=[{fieldId:"exercise",name:"運動",order:10,display:!0},{fieldId:"meal",name:"食事",order:20,display:!0},{fieldId:"sleep",name:"睡眠",order:30,display:!0},{fieldId:"smoke",name:"喫煙",order:40,display:!1},{fieldId:"alcohol",name:"飲酒",order:50,display:!1}],i=u.useCallback(async()=>{const e=await h();t(e)},[]),n=u.useCallback(async()=>{const e=await y();s(e)},[]);u.useEffect(()=>{(async()=>{const e=await h();if(!e||0===e.length){for(const e of l)await b(e);t(await h())}})()},[]),u.useEffect(()=>{i(),n()},[i,n]);const d=u.useCallback((e,t)=>a.find(a=>a.fieldId===e&&a.date===t),[a]),r=u.useCallback((e,t)=>{const a=d(e,t);if("number"==typeof(null==a?void 0:a.value)){if(1===a.value)return 1;if(.5===a.value)return.5;if(0===a.value)return 0}},[d]),o=u.useCallback(t=>{const s=v(t),l=e.map(e=>e.fieldId);return a.some(e=>e.date===s&&l.includes(e.fieldId))},[e,a]),c=u.useCallback(async(e,t,a)=>{const s=d(e,a);if(s&&s.value===t)await w(s.id),await n();else if(s)await j({...s,value:t}),await n();else{const s=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;await k({id:s,fieldId:e,date:a,value:t}),await n()}},[d,n]),m=u.useCallback(async t=>{if(!t.trim())throw new Error("項目名を入力してください");if(e.some(e=>e.name===t))throw new Error("同じ名前の項目が既に存在します");const a={fieldId:`custom_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,name:t,order:10*(e.length+1),display:!0};return await b(a),await i(),a},[e,i]),f=u.useCallback(async e=>{await I(e),await i()},[i]),x=u.useCallback(async e=>{await D(e),await i()},[i]),g=u.useCallback(()=>{const e=new Date,t=[];for(let a=0;a<14;a++){const s=new Date(e);s.setDate(e.getDate()-a),t.push(v(s))}return t.reverse()},[]),p=u.useCallback(e=>{const t=g();let s=0,l=0;return t.forEach(t=>{const i=a.find(a=>a.fieldId===e&&a.date===t);"number"==typeof(null==i?void 0:i.value)&&(s++,i.value>0&&l++)}),{total:s,success:l,percent:s>0?Math.round(l/s*100):0}},[a,g]),C=u.useCallback(t=>{if(0===a.length)return 0;const s=e.map(e=>e.fieldId),l=a.map(e=>e.date).sort();if(0===l.length)return 0;const i=new Date(l[0]);let n=0;for(let e=new Date(t);e>=i;e.setDate(e.getDate()-1)){const t=v(e);if(!s.some(e=>a.some(a=>a.fieldId===e&&a.date===t&&"number"==typeof a.value&&a.value>0)))break;n++}return n>1?n:0},[a,e]),N=u.useCallback(t=>{const s=e.map(e=>e.fieldId);if(0===a.length)return 0;const l=a.map(e=>e.date).sort(),i=new Date(l[0]),n=t;let d=0;for(let e=new Date(i);e<=n;e.setDate(e.getDate()+1)){const t=v(e);s.some(e=>a.some(a=>a.fieldId===e&&a.date===t&&"number"==typeof a.value&&a.value>0))&&d++}return d},[a,e]),S=u.useCallback(t=>{const s=v(t),l=e.map(e=>e.fieldId),i=a.filter(e=>e.date===s&&l.includes(e.fieldId));return 0===i.length?"none":i.some(e=>1===e.value||.5===e.value)?"green":"red"},[a,e]),E=u.useCallback((t,s)=>t?e.slice().sort((e,t)=>(e.order??0)-(t.order??0)):e.filter(e=>"display"in e&&!1!==e.display||(s?a.some(t=>t.fieldId===e.fieldId&&t.date===s&&null!==t.value&&void 0!==t.value):a.some(t=>t.fieldId===e.fieldId&&null!==t.value&&void 0!==t.value))).sort((e,t)=>(e.order??0)-(t.order??0)),[e,a]);return{fields:e,records:a,loadFields:i,loadRecords:n,getBoolRecord:d,getAchievementValue:r,isRecorded:o,handleAchievementInput:c,addField:m,deleteField:f,updateField:x,getFieldSuccessStats:p,calcStreak:C,calcTotalAchievedDays:N,getDateStatus:S,getDisplayFields:E}})(),{selectedDate:X,setSelectedDate:Y,centerDate:Z,setCenterDate:ee,recordDate:te}=$({records:g,getRecordDate:e=>e.date}),[ae,se]=u.useState(!1),[le,ie]=u.useState(""),[ne,de]=u.useState(""),[re,oe]=u.useState(!1),ce=Q(re,te),[ue,me]=u.useState([]),[fe,xe]=u.useState(()=>ce.map(e=>e.fieldId)),[ge,pe]=u.useState([]),he=s(l(c));u.useEffect(()=>{if(re){const e=x.slice().sort((e,t)=>(e.order??0)-(t.order??0));me(e.map(e=>({fieldId:e.fieldId,name:e.name,order:e.order??0,display:"display"in e?e.display:"boolean"!=typeof e.defaultDisplay||(e.defaultDisplay??!0)}))),xe(e.map(e=>e.fieldId)),pe([])}},[re,x]);const[ye,be]=u.useState(null),ve=u.useRef({}),we=u.useRef({});u.useEffect(()=>{if(!ye)return;const e=ve.current[ye];if(e){const t=we.current[ye]??{start:e.value.length,end:e.value.length};e.setSelectionRange(t.start,t.end)}},[ye]);const je=u.useCallback((e,t,a)=>{we.current[e]={start:t,end:a}},[]),ke=u.useCallback(e=>{pe(t=>[...t,e]),me(t=>t.filter(t=>t.fieldId!==e)),xe(t=>t.filter(t=>t!==e))},[]),Ie=u.useCallback(e=>{me(t=>t.map(t=>t.fieldId===e?{...t,display:!t.display}:t))},[]),De=H(X),Ce=P(De),Ne=P(L(X));return e.jsxs("div",{className:"bg-transparent",children:[e.jsx(W,{selectedDate:X,setSelectedDate:Y,centerDate:Z,setCenterDate:ee,getDateStatus:J,checkpointDates:t,"data-testid":"date-picker"}),e.jsx("div",{className:"w-full max-w-md mx-auto mt-3 mb-3 flex justify-start pl-4",children:e.jsxs("span",{className:"text-lg sm:text-xl font-bold text-gray-800 dark:text-white",children:[te,O(X)&&e.jsx(S,{className:"inline-block w-6 h-6 text-green-500 ml-2 align-middle","aria-label":"入力済み"}),e.jsxs("span",{className:"inline-flex items-center",children:[De>=2&&e.jsxs("span",{className:"ml-3 px-2 py-0.5 rounded-full bg-orange-500 text-white text-xs font-bold inline-flex items-center",title:"連続達成日数",children:[e.jsx(M,{className:"inline-block mr-1",style:{fontSize:"1em"}}),e.jsx("span",{style:{display:"inline-block",minWidth:"3ch",textAlign:"right"},children:Ce.toFixed(0)}),"日継続中"]}),e.jsxs("span",{className:"ml-3 px-2 py-0.5 rounded-full bg-blue-500 text-white text-xs font-bold inline-flex items-center",title:"累計達成日数",children:[e.jsx("span",{className:"inline-block mr-1",style:{fontSize:"1em"},children:"🏅"}),e.jsx("span",{style:{display:"inline-block",minWidth:"3ch",textAlign:"right"},children:Ne.toFixed(0)}),"日達成"]})]})]})}),e.jsxs("div",{className:"flex flex-col items-center justify-start min-h-[60vh]",children:[e.jsx("div",{className:"flex flex-col gap-1 w-full max-w-md",children:re?e.jsx(i,{sensors:he,collisionDetection:n,onDragEnd:e=>{const{active:t,over:a}=e;if(!a)return;const s=String(t.id),l=String(a.id);if(s!==l){const e=fe.indexOf(s),t=fe.indexOf(l);xe(o(fe,e,t))}},children:e.jsx(d,{items:fe,strategy:r,children:fe.map(t=>{const a=ue.find(e=>e.fieldId===t);if(!a)return null;const s=ye===a.fieldId;return e.jsx(q,{field:a,isEditing:s,onStartEdit:()=>be(a.fieldId),onEndEdit:()=>be(null),onNameChange:e=>me(t=>t.map(t=>t.fieldId===a.fieldId?{...t,name:e}:t)),onDelete:()=>ke(a.fieldId),onToggleDisplay:()=>Ie(a.fieldId),inputRef:e=>ve.current[a.fieldId]=e,onCaretPositionChange:je},a.fieldId)})})}):ce.map(t=>{const a=p(t.fieldId,te),s=G(t.fieldId);return e.jsx(T,{field:t,value:a,stats:s,onAchieve:async()=>{await K(t.fieldId,1,te)},onPartial:async()=>{await K(t.fieldId,.5,te)},onUnachieve:async()=>{await K(t.fieldId,0,te)}},t.fieldId)})}),re&&e.jsxs("div",{className:"w-full max-w-md mt-2 mb-2",children:[ae?e.jsxs("div",{className:"flex items-center gap-1 mb-1 bg-white dark:bg-gray-800 rounded-xl shadow p-2",children:[e.jsx("input",{type:"text",value:le,onChange:e=>ie(e.target.value),className:"flex-1 border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400",placeholder:"新しい項目名",maxLength:20,"data-testid":"daily-input-2"}),e.jsx(R,{variant:"primary",size:"md",icon:S,"aria-label":"保存",onClick:async()=>{de("");try{const e=await U(le);re&&(me(t=>[...t,e]),xe(t=>[...t,e.fieldId])),se(!1),ie("")}catch(e){de(e instanceof Error?e.message:"エラーが発生しました")}},disabled:!le.trim(),"data-testid":"save-btn",children:""}),e.jsx(R,{variant:"secondary",size:"md",icon:E,"aria-label":"キャンセル",onClick:()=>{se(!1),ie(""),de("")},children:""})]}):e.jsx(R,{variant:"teal",size:"md",icon:F,fullWidth:!0,onClick:()=>se(!0),"data-testid":"add-btn",children:"新規項目"}),ne&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:ne})]}),e.jsx("div",{className:"w-full max-w-md mt-2 mb-2",children:re?e.jsxs("div",{className:"flex gap-1",children:[e.jsx(R,{variant:"success",size:"md",icon:A,onClick:async()=>{await f(async()=>{for(const e of ge)await V(e);for(let e=0;e<fe.length;++e){const t=ue.find(t=>t.fieldId===fe[e]);t&&await _({...t,order:10*e})}oe(!1)})},fullWidth:!0,loading:"saving"===m,success:"success"===m,pulseOnClick:!0,children:"保存"}),e.jsx(R,{variant:"secondary",size:"md",icon:E,onClick:()=>{oe(!1)},fullWidth:!0,children:"キャンセル"})]}):e.jsx(R,{variant:"teal",size:"md",icon:z,fullWidth:!0,onClick:()=>oe(!0),children:"編集"})}),e.jsx("div",{className:"w-full max-w-md mx-auto mb-2 px-4",children:e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900 border-l-4 border-yellow-400 text-yellow-800 dark:text-yellow-100 p-3 rounded shadow-sm text-sm text-left",children:[e.jsx("strong",{children:"【ワンポイント】"})," ","日課は毎日少しずつでも続けることが大切です。完璧を目指さず、できた日を積み重ねましょう。少しでもやったら微達成として記録しましょう。"]})})]})]})};export{O as default};
