import{j as e,F as t,u as a,a as s,b as l,c as r,d as n,o,f as i,s as c}from"./ui-vendor-J9A7wRLG.js";import{o as d}from"./state-vendor-RA6ewXRt.js";import{a as m,d as x}from"./react-vendor-C4GzcRrE.js";import{A as h,u,a as g,D as b,g as p,H as f,b as w,c as y}from"./index-Be0Vy4eT.js";import{u as j,a as N,P as v,N as k,T as F,M as C}from"./useRecordForm-D4MBSvih.js";import{B as D}from"./Button-DQwbRege.js";import{u as S,D as M}from"./useDateSelection-DBT0A6Ic.js";import{u as R}from"./useSaveState-DbkjJmWD.js";import"./icons-vendor-DCv9Y2bB.js";const W=[{min:0,max:18.5,color:"#6ec6f1",label:"低体重",range:"<18.5"},{min:18.5,max:25,color:"#7edfa0",label:"普通体重",range:"18.5-24.9"},{min:25,max:30,color:"#b6d97a",label:"肥満(1度)",range:"25-29.9"},{min:30,max:35,color:"#ffe066",label:"肥満(2度)",range:"30-34.9"},{min:35,max:40,color:"#ff9800",label:"肥満(3度)",range:"35-39.9"},{min:40,max:100,color:"#f44336",label:"肥満(4度)",range:"40.0+"}],E=function({currentWeight:t,goal:a,showWeightDiff:s=!0}){if(!a)return null;const l=null==a?void 0:a.height,r=null==a?void 0:a.startWeight,n=t&&l?t/Math.pow(l/100,2):null,o="number"!=typeof n||isNaN(n)?0:n,i=(()=>{if(null===n)return 0;let e=0;for(let t=0;t<W.length;t++){const a=W[t];if(n<a.max){return e+100/W.length*((n-a.min)/(a.max-a.min))}e+=100/W.length}return 100})(),[c,d]=m.useState(0);m.useEffect(()=>{if("number"!=typeof n||isNaN(n))return;const e=performance.now();requestAnimationFrame(function t(a){const s=a-e,l=Math.min(s/800,1);d(0+(o-0)*l),l<1?requestAnimationFrame(t):d(o)})},[o,n]);const[x,h]=m.useState(0);return m.useEffect(()=>{if(s&&void 0!==r&&null!==t&&t-r<0){let e=function(t){const r=t-n,o=Math.min(r/l,1);h(s+(a-s)*o),o<1?requestAnimationFrame(e):h(a)};const a=t-r,s=0,l=800,n=performance.now();requestAnimationFrame(e)}else h(0)},[r,t,s]),n&&l?e.jsxs("div",{className:"w-full max-w-md mx-auto",children:[s&&e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsxs("span",{className:"text-base font-semibold text-blue-700 dark:text-blue-200",children:["BMI"," ",e.jsx("span",{style:{display:"inline-block",minWidth:"4ch",textAlign:"right",fontFamily:"monospace"},children:c.toFixed(1)})]}),s&&x<0&&e.jsxs("span",{className:"ml-2 text-base font-semibold text-green-600 dark:text-green-400",children:["🏆",x.toFixed(1),"kg"]})]}),e.jsxs("div",{className:"flex flex-col items-center mb-2",children:[e.jsxs("div",{className:"relative w-full h-8 flex rounded overflow-hidden shadow",style:{minWidth:240},children:[W.map(t=>e.jsx("div",{className:"flex-1 flex flex-col items-center justify-center",style:{backgroundColor:t.color},title:`${t.label} (${t.range})`,children:e.jsx("span",{className:"text-[10px] font-bold text-gray-800 dark:text-gray-900",children:t.label})},t.label)),e.jsx("div",{className:"absolute top-0 text-red-600 text-lg font-bold",style:{left:`${i}%`,transform:"translateX(-50%)",lineHeight:"32px",fontSize:"20px",fontWeight:"bold",textShadow:"0 0 2px #fff, 0 0 2px #fff, 1px 1px 2px #0002",zIndex:2},"aria-label":"現在のBMI位置",children:"▼"})]}),e.jsx("div",{className:"w-full flex justify-between mt-1 px-1",children:W.map(t=>e.jsx("span",{className:"text-[10px] text-gray-700 dark:text-gray-200",style:{flex:1,textAlign:"center"},children:t.range},t.label+"-range"))})]})]}):null},G=["朝一","朝食後","夕食前","夕食後","就寝前","運動後に測定","外食あり"],B={weight:"",bodyFat:"",waist:"",time:p(),note:"",excludeFromGraph:!1};const $=d(({showTipsModal:d})=>{const{goal:p,loadGoal:W}=h(),{checkpointDates:$}=u(),I=g(),{saveState:A,executeSave:z}=R({onSuccess:()=>{I.showSuccess("体重記録を保存しました！"),d&&d()},onError:e=>{I.showError(`保存に失敗しました: ${e.message}`)}}),P=m.useCallback(async()=>{const e=await b.getAll();if(!e.success)throw new Error(e.error||"Failed to fetch records");return e.data||[]},[]),O=m.useCallback(async e=>{const t=await b.add(e);if(!t.success)throw new Error(t.error||"Failed to add record")},[]),T=m.useCallback(async e=>{const t=await b.update(e);if(!t.success)throw new Error(t.error||"Failed to update record")},[]),q=m.useCallback(async e=>{const t=await b.delete(e);if(!t.success)throw new Error(t.error||"Failed to delete record")},[]),{records:L,isLoading:V,error:H,handleAdd:J,handleUpdate:U,handleDelete:X,clearError:K}=j({getAllRecords:P,addRecord:O,updateRecord:T,deleteRecord:q}),{selectedDate:Q,setSelectedDate:Y,centerDate:Z,setCenterDate:_,today:ee,recordDate:te,recordsOfDay:ae,isRecorded:se}=S({records:L,getRecordDate:e=>e.date}),{formData:le,updateField:re,resetForm:ne,createRecordFromForm:oe}=N({initialValues:B,createRecord:(e,t)=>({id:`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,date:t,time:e.time,weight:Number(e.weight),bodyFat:""!==e.bodyFat?Number(e.bodyFat):null,waist:""!==e.waist?Number(e.waist):null,note:e.note||null,excludeFromGraph:e.excludeFromGraph}),resetValues:B}),ie=(()=>{const e=m.useCallback((e,t)=>t<=0?0:Number((e/Math.pow(t/100,2)).toFixed(2)),[]),t=m.useCallback((e,t)=>Number((e-t).toFixed(2)),[]),a=m.useCallback(e=>0===e.length?0:Math.min(...e.map(e=>Number(e.weight))),[]),s=m.useCallback(e=>!!(e.weight||e.bodyFat||e.waist),[]),l=m.useCallback((s,l)=>{const r=s.length>0,n=l&&l.height&&l.height>0;if(!r||!n)return{shouldShowBMI:!1,bmi:0,weightChange:0,lowestWeight:0};const o=a(s);return{shouldShowBMI:!0,bmi:e(o,l.height),weightChange:t(o,l.startWeight||0),lowestWeight:o}},[e,t,a]),r=m.useCallback(e=>e<18.5?{category:"低体重",color:"text-blue-600"}:e<25?{category:"普通体重",color:"text-green-600"}:e<30?{category:"肥満度1",color:"text-yellow-600"}:{category:"肥満度2以上",color:"text-red-600"},[]),n=m.useCallback(e=>e>0?{text:`+${e}kg`,color:"text-red-600",icon:"↗"}:e<0?{text:`${e}kg`,color:"text-blue-600",icon:"↘"}:{text:"±0kg",color:"text-gray-600",icon:"→"},[]),o=m.useCallback(e=>!!(e.weight&&e.weight>0),[]),i=m.useCallback(e=>[...e].sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()),[]);return{calculateBMI:e,calculateWeightChange:t,calculateLowestWeight:a,calculateBMIDisplayInfo:l,hasRecordData:s,isValidRecord:o,getBMICategory:r,getWeightChangeDisplay:n,sortRecordsByDateTime:i,noteExamples:G}})(),ce=m.useMemo(()=>0===ae.length?null:ie.calculateLowestWeight(ae),[ae,ie]),de=m.useMemo(()=>ce&&p&&p.height?ie.calculateBMI(ce,p.height):null,[ce,p,ie]),me=m.useMemo(()=>ce&&p&&p.startWeight?ie.calculateWeightChange(ce,p.startWeight):null,[ce,p,ie]),xe=!!p,he=!!(null==p?void 0:p.height);x.useEffect(()=>{xe&&he||W()},[xe,he,W]);const ue=ie.hasRecordData(le),ge=m.useCallback(async()=>{ue&&await z(async()=>{const e=oe(te);await J(e),ne()})},[ue,oe,te,J,ne,z]),be=m.useCallback(async e=>{try{await X(e.id),I.showSuccess("記録を削除しました")}catch(t){I.showError(`削除に失敗しました: ${t instanceof Error?t.message:"不明なエラー"}`)}},[X,I]),pe=function(){const[e,t]=m.useState(!1),{refs:d,floatingStyles:x,context:h}=a({open:e,onOpenChange:t,middleware:[o(6),i(),c()],placement:"bottom-end"}),u=s(h),g=l(h),b=r(h),{getReferenceProps:p,getFloatingProps:f}=n([u,g,b]);return{open:e,setOpen:t,refs:d,floatingStyles:x,getReferenceProps:p,getFloatingProps:f}}();return e.jsxs("div",{className:"bg-transparent",children:[e.jsx(M,{selectedDate:Q,setSelectedDate:Y,centerDate:Z,setCenterDate:_,today:ee,isRecorded:se,checkpointDates:$,"data-testid":"date-picker"}),e.jsx("div",{className:"w-full max-w-md mx-auto mt-3 mb-3 flex justify-start pl-4",children:e.jsxs("span",{className:"text-lg sm:text-xl font-bold text-gray-800 dark:text-white",children:[Q.toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric"}),se(Q)&&e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"inline-block w-6 h-6 text-green-500 ml-2 align-middle","aria-label":"入力済み"}),null!==de&&e.jsxs("span",{className:"ml-3 text-base font-semibold text-blue-700 dark:text-blue-200 align-middle",children:["BMI ",de.toFixed(1),null!==me&&me<0&&e.jsxs("span",{className:"ml-2 text-base font-semibold text-green-600 dark:text-green-400",children:["🏆",me.toFixed(1),"kg"]})]})]})]})}),e.jsx(E,{currentWeight:ce,goal:p,showWeightDiff:!1}),e.jsxs("div",{className:"flex flex-col items-center justify-start min-h-[60vh]",children:[H&&e.jsx("div",{className:"w-full max-w-md mb-4",children:e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:[e.jsx("p",{className:"text-red-800 text-sm",children:H}),e.jsx("button",{onClick:K,className:"mt-2 text-red-600 hover:text-red-800 text-sm underline",children:"エラーを閉じる"})]})}),e.jsx("div",{className:"flex flex-col gap-2 w-full max-w-md",children:ae.map(t=>e.jsxs("div",{className:"flex flex-col gap-1 bg-white dark:bg-gray-800 rounded-xl shadow p-2 mb-1",children:[e.jsxs("div",{className:"flex items-center w-full mb-1 justify-between",children:[e.jsx("input",{type:"time",className:"h-10 border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-base bg-inherit text-gray-700 dark:text-gray-200 w-[6.5em]",value:t.time,onChange:e=>U({...t,time:e.target.value})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{variant:"danger",size:"sm",icon:w,"aria-label":"削除",onClick:()=>be(t),pulseOnClick:!0,children:""}),e.jsxs(D,{variant:t.excludeFromGraph?"secondary":"sky",size:"sm","aria-label":t.excludeFromGraph?"グラフ除外":"グラフ表示",onClick:()=>U({...t,excludeFromGraph:!t.excludeFromGraph}),children:["",e.jsxs("span",{className:"relative inline-block w-5 h-5",children:[e.jsx(v,{className:"w-5 h-5 text-white"}),t.excludeFromGraph&&e.jsx(y,{className:"w-5 h-5 text-red-500 absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2"})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 w-full",children:[e.jsx(k,{value:t.weight,onChange:e=>U({...t,weight:Number(e)}),placeholder:"体重",step:"0.1",min:"0",width:"lg"}),e.jsx("span",{className:"ml-0.5 mr-3 text-gray-500",children:"kg"}),e.jsx(k,{value:t.bodyFat??"",onChange:e=>U({...t,bodyFat:""===e?null:Number(e)}),placeholder:"体脂肪",step:"0.1",min:"0",width:"lg"}),e.jsx("span",{className:"ml-0.5 mr-3 text-gray-500",children:"%"}),e.jsx(k,{value:t.waist??"",onChange:e=>U({...t,waist:""===e?null:Number(e)}),placeholder:"腹囲",step:"0.1",min:"0",width:"lg"}),e.jsx("span",{className:"ml-0.5 mr-3 text-gray-500",children:"cm"})]}),e.jsx("textarea",{className:"h-10 border border-gray-300 dark:border-gray-600 rounded-lg px-2 py-1 text-base bg-inherit text-gray-700 dark:text-gray-200 resize-none w-full pr-10 mb-0",defaultValue:t.note??"",onBlur:e=>U({...t,note:e.target.value}),placeholder:"補足・メモ（任意）"})]},t.id))}),e.jsx("div",{className:"w-full max-w-md mt-2 mb-2",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow p-2 mb-0 flex flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center w-full mb-1 justify-between",children:[e.jsx(F,{value:le.time,onChange:e=>re("time",e)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{variant:"success",size:"sm",icon:f,"aria-label":"保存",onClick:ge,"data-testid":"save-btn",disabled:V||!ue,loading:"saving"===A,success:"success"===A,pulseOnClick:!0,children:""}),e.jsxs(D,{variant:le.excludeFromGraph?"secondary":"sky",size:"sm","aria-label":le.excludeFromGraph?"グラフ除外":"グラフ表示",onClick:()=>re("excludeFromGraph",!le.excludeFromGraph),children:["",e.jsxs("span",{className:"relative inline-block w-5 h-5",children:[e.jsx(v,{className:"w-5 h-5 text-white"}),le.excludeFromGraph&&e.jsx(y,{className:"w-5 h-5 text-red-500 absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2"})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 w-full mb-1",children:[e.jsx(k,{value:le.weight,onChange:e=>re("weight",e),placeholder:"体重",step:"0.1",min:"0",width:"lg"}),e.jsx("span",{className:"ml-0.5 mr-3 text-gray-500",children:"kg"}),e.jsx(k,{value:le.bodyFat,onChange:e=>re("bodyFat",e),placeholder:"体脂肪",step:"0.1",min:"0",width:"lg"}),e.jsx("span",{className:"ml-0.5 mr-3 text-gray-500",children:"%"}),e.jsx(k,{value:le.waist,onChange:e=>re("waist",e),placeholder:"腹囲",step:"0.1",min:"0",width:"lg"}),e.jsx("span",{className:"ml-0.5 mr-3 text-gray-500",children:"cm"})]}),e.jsxs("div",{className:"relative w-full mt-0",children:[e.jsx("textarea",{className:"h-10 border border-gray-300 dark:border-gray-600 rounded-lg px-2 py-1 text-base bg-inherit text-gray-700 dark:text-gray-200 resize-none w-full pr-10 mb-0",rows:1,value:le.note,onChange:e=>re("note",e.target.value),placeholder:"補足・メモ（任意）"}),e.jsx("div",{ref:pe.refs.setReference,...pe.getReferenceProps({}),className:"absolute right-2 top-1/2 -translate-y-1/2 w-6 h-6 flex items-center justify-center text-yellow-400 cursor-pointer align-middle hover:opacity-80 focus:outline-none",tabIndex:0,"aria-label":"定型文を挿入",onClick:()=>pe.setOpen(e=>!e),children:e.jsx(C,{className:"w-6 h-6"})}),pe.open&&e.jsx(t,{children:e.jsx("div",{ref:pe.refs.setFloating,style:pe.floatingStyles,...pe.getFloatingProps({className:"z-30 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded shadow-lg min-w-[180px] py-1"}),children:ie.noteExamples.map(t=>e.jsx("button",{type:"button",className:"block w-full text-left px-4 py-2 text-sm hover:bg-yellow-100 dark:hover:bg-yellow-900",onClick:()=>{re("note",t),pe.setOpen(!1)},children:t},t))})})]})]})}),e.jsx("div",{className:"w-full max-w-md mx-auto mb-2 px-4",children:e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900 border-l-4 border-yellow-400 text-yellow-800 dark:text-yellow-100 p-3 rounded shadow-sm text-sm text-left",children:[e.jsx("strong",{children:"【ワンポイント】"})," ","体重はできるだけ毎日同じタイミング（例：朝起きてトイレ後、食事前など）で測ると、日々の変化がより正確にわかります。同じタイミングではない記録はグラフから除外できます。"]})})]})]})});export{$ as default};
