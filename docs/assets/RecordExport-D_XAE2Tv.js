import{j as e}from"./ui-vendor-C-Wy2eYm.js";import{a as t}from"./react-vendor-C-KyEapP.js";import{H as a,a as s,b as r,c as l,u as i,p as n,i as d,d as o,e as c,B as m,f as x,g as u,h,j as f}from"./index-DK9mZFQB.js";import"./icons-vendor-DjdN70Ov.js";import"./dnd-vendor-BRc0Lj2o.js";import"./state-vendor-JWNWXe5-.js";const g={success:{containerClass:"bg-green-50 border-green-200 text-green-700",iconClass:"text-green-600",defaultIcon:l},error:{containerClass:"bg-red-50 border-red-200 text-red-700",iconClass:"text-red-600",defaultIcon:r},warning:{containerClass:"bg-amber-50 border-amber-200 text-amber-700",iconClass:"text-amber-600",defaultIcon:s},info:{containerClass:"bg-blue-50 border-blue-200 text-blue-700",iconClass:"text-blue-600",defaultIcon:a}},p="p-4 rounded-lg border font-medium flex items-start gap-3 shadow-sm",b=({type:a,message:s,autoHide:r=!1,hideDelay:l=3e3,onHide:i,className:n="",icon:d})=>{const[o,c]=t.useState(!0),m=g[a],x=d||m.defaultIcon;if(t.useEffect(()=>{if(r&&l>0){const e=setTimeout(()=>{c(!1),null==i||i()},l);return()=>clearTimeout(e)}},[r,l,i]),!o)return null;const u=[p,m.containerClass,n].join(" ");return e.jsxs("div",{className:u,role:"alert","aria-live":"polite",children:[e.jsx(x,{className:`w-5 h-5 ${m.iconClass} flex-shrink-0 mt-0.5`,"aria-hidden":"true"}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"text-sm leading-relaxed",children:s})})]})},w=t=>e.jsx(b,{type:"success",...t}),j=t=>e.jsx(b,{type:"error",...t}),v=t=>e.jsx(b,{type:"info",...t});function y(e){return`${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}${String(e.getHours()).padStart(2,"0")}${String(e.getMinutes()).padStart(2,"0")}${String(e.getSeconds()).padStart(2,"0")}`}function N({showTipsModal:a}){var r,l;const{records:g,fields:p,loadRecords:b,loadFields:N,deleteAllData:k,initializeFields:S,addRecord:$}=i(),[C,I]=t.useState(null),[E,O]=t.useState(null),[R,T]=t.useState(0),[L,U]=t.useState(!1),[D,W]=t.useState(null),[z,J]=t.useState(null),[V,A]=t.useState(!1);if(D)throw D;t.useEffect(()=>(n.trackRender.start("RecordExport"),()=>{n.trackRender.end("RecordExport")})),t.useEffect(()=>{},[g.length,p.length,C,E,R,L]);const F=(()=>{performance.now();const e=[...g].sort((e,t)=>{const a=`${e.date} ${e.time}`;return`${t.date} ${t.time}`.localeCompare(a)});return performance.now(),e})(),H=async(e,t)=>{I("データをインポート中...");try{const s=await e.text();let r;if("json"===t){if(r=JSON.parse(s),!Array.isArray(r))throw new Error("JSON file format is incorrect")}else r=(e=>{const t=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").trim().split("\n");if(t.length<2)throw new Error("CSVファイルが空または形式が正しくありません");const a=e=>{const t=[];let a="",s=!1,r=0;for(;r<e.length;){const l=e[r];'"'===l?s&&'"'===e[r+1]?(a+='"',r+=2):(s=!s,r++):","!==l||s?(a+=l,r++):(t.push(a),a="",r++)}return t.push(a),t},s=a(t[0]),r=["id","date","time","datetime","fieldId","fieldName","value"];if(!r.every(e=>s.includes(e)))throw console.error("Expected headers:",r),console.error("Actual headers:",s),new Error(`CSV file format is incorrect. Required columns: ${r.join(", ")}`);const l=[];for(let n=1;n<t.length;n++)try{if(!t[n].trim())continue;const e=a(t[n]);if(e.length!==s.length){s.length,e.length;continue}const r={id:e[s.indexOf("id")],date:e[s.indexOf("date")],time:e[s.indexOf("time")],datetime:e[s.indexOf("datetime")],fieldId:e[s.indexOf("fieldId")],value:e[s.indexOf("value")]};if(!(r.id&&r.date&&r.time&&r.fieldId))continue;"yes"===r.value||"あり"===r.value?r.value=!0:"no"===r.value||"なし"===r.value?r.value=!1:isNaN(Number(r.value))||""===r.value||(r.value=Number(r.value)),l.push(r)}catch(i){throw console.error(`Row ${n} parsing error:`,i),new Error(`${n}行目の処理でエラーが発生しました: ${i instanceof Error?i.message:"不明なエラー"}`)}return l})(s);for(const e of r)if(!(e.id&&e.date&&e.time&&e.fieldId))throw new Error("Data is missing required fields");let l=0;for(const e of r)try{await $(e),l++}catch(a){e.id}await b(),I(`✅ ${l}データをインポートしました`),setTimeout(()=>I(null),3e3)}catch(a){const e=a instanceof Error?a:new Error("Unknown error");console.error("Import error:",e),I(`❌ データのインポートに失敗しました: ${e.message}`),setTimeout(()=>I(null),5e3)}};return e.jsxs("div",{className:"max-w-full sm:max-w-4xl mx-auto sm:px-0",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 mb-8",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-800 dark:text-white mb-6",children:"データの詳細"}),e.jsxs("div",{className:"text-base text-gray-600 dark:text-gray-300 space-y-3",children:[e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(o,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),e.jsx("strong",{className:"text-gray-800 dark:text-white",children:"総レコード数"})," ",F.length]}),e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(c,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),e.jsx("strong",{className:"text-gray-800 dark:text-white",children:"期間"})," ",F.length>0?`${null==(r=F[F.length-1])?void 0:r.date} 〜 ${null==(l=F[0])?void 0:l.date}`:"データなし"]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 mb-8",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-800 dark:text-white mb-6",children:"データのエクスポート"}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300 mb-6",children:"データをCSVまたはJSON形式でエクスポートします。"}),e.jsxs("div",{className:"flex flex-col gap-4 mb-6",children:[e.jsx(m,{variant:"purple",size:"lg",icon:x,onClick:()=>{const e=function(e,t,a){return[["id","date","time","datetime","fieldId","fieldName","value"],...e.map(e=>{const s=t.find(t=>t.fieldId===e.fieldId);return[e.id,e.date,e.time,e.datetime,e.fieldId,s?s.name:"","boolean"==typeof e.value?e.value?a("fields.yes"):a("fields.no"):e.value]})].map(e=>e.map(String).map(e=>`"${e.replace(/"/g,'""')}"`).join(",")).join("\r\n")}(F,p,e=>e),t=new Blob([e],{type:"text/csv"}),a=URL.createObjectURL(t),s=document.createElement("a");s.href=a,s.download=`records-${y(new Date)}.csv`,s.click(),URL.revokeObjectURL(a)},fullWidth:!1,"data-testid":"download-csv-btn",children:"CSV形式でエクスポート"}),e.jsx(m,{variant:"purple",size:"lg",icon:x,onClick:()=>{const e=JSON.stringify(F,null,2),t=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(t),s=document.createElement("a");s.href=a,s.download=`records-${y(new Date)}.json`,s.click(),URL.revokeObjectURL(a)},fullWidth:!1,"data-testid":"download-json-btn",children:"JSON形式でエクスポート"})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 mb-8",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-800 dark:text-white mb-6",children:"データのインポート"}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300 mb-6",children:"データをCSVまたはJSON形式でインポートします。"}),C&&e.jsxs("div",{className:"mb-6",children:[C.includes("✅")&&e.jsx(w,{message:C.replace("✅ ","")}),C.includes("❌")&&e.jsx(j,{message:C.replace("❌ ","")}),!C.includes("✅")&&!C.includes("❌")&&e.jsx(v,{message:C})]}),e.jsx("div",{className:"flex flex-col gap-4 mb-6",children:e.jsxs("div",{children:[e.jsx("input",{type:"file",accept:".csv,.json",onChange:e=>{var t;const a=null==(t=e.target.files)?void 0:t[0];if(a){const t=a.name.toLowerCase();let s;if(t.endsWith(".csv"))s="csv";else{if(!t.endsWith(".json"))return I("サポートされていないファイル形式です"),setTimeout(()=>I(null),3e3),void(e.target.value="");s="json"}H(a,s)}e.target.value=""},className:"hidden",id:"data-import"}),e.jsxs("label",{htmlFor:"data-import",className:"bg-purple-600 text-white px-6 py-3 rounded-lg font-medium shadow-md hover:bg-purple-700 hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2 w-auto cursor-pointer",children:[e.jsx(u,{className:"w-5 h-5"}),"ファイルを選択"]})]})})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 mb-8",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-800 dark:text-white mb-4",children:"TIPS"}),e.jsx(m,{variant:"purple",size:"lg",icon:h,onClick:()=>a&&a(),fullWidth:!0,children:"TIPSを表示"})]}),d,d,e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-2xl shadow-md p-6 mb-8",children:[e.jsxs("h2",{className:"text-2xl font-semibold text-red-800 dark:text-red-400 mb-6 flex items-center gap-2",children:[e.jsx(s,{className:"w-6 h-6 text-red-600 dark:text-red-500"}),"危険ゾーン"]}),e.jsx("div",{className:"mb-6 text-left",children:e.jsx("p",{className:"text-base text-red-700 dark:text-red-300 mb-3",children:"すべてのデータを削除してもよろしいですか？この操作は元に戻せません。"})}),e.jsx(m,{variant:"danger",size:"lg",icon:f,onClick:async()=>{if(window.confirm("すべてのデータを削除してもよろしいですか？")){if(window.confirm("本当に削除してもよろしいですか？この操作は元に戻せません。"))try{await k(),await S(),await N(),await b(),alert("すべてのデータを削除しました")}catch(e){console.error("Delete error:",e),alert("データの削除に失敗しました")}}},fullWidth:!1,children:"すべてのデータを削除"})]}),e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-2xl shadow-md p-6 mt-8",children:[e.jsxs("h2",{className:"text-xl font-semibold text-yellow-800 dark:text-yellow-400 mb-4 flex items-center gap-2",children:[e.jsx(s,{className:"w-5 h-5 text-yellow-600 dark:text-yellow-500"}),"既存データのdatetime一括修正（危険・一時的）"]}),e.jsx("div",{className:"mb-4 text-left",children:e.jsxs("p",{className:"text-base text-yellow-700 dark:text-yellow-300 mb-2",children:["既存の全レコードについて、date＋timeからdatetimeを再生成して一括修正します。",e.jsx("br",{}),"※一時的な救済用です。通常利用時は不要です。"]})}),e.jsx(m,{variant:"warning",size:"lg",icon:s,onClick:async()=>{A(!0),J("修正中...");try{let e=0;for(const t of g)if(t.date&&t.time){const a=`${t.date}T${t.time}:00`;t.datetime!==a&&(await $({...t,datetime:a}),e++)}await b(),J(`✅ 修正完了: ${e}件修正しました`)}catch(e){J("❌ 修正中にエラーが発生しました")}finally{A(!1),setTimeout(()=>J(null),4e3)}},fullWidth:!1,disabled:V,loading:V,children:"既存データのdatetime一括修正"}),z&&e.jsx("div",{className:"mt-4",children:z.includes("✅")?e.jsx(w,{message:z.replace("✅ ","")}):z.includes("❌")?e.jsx(j,{message:z.replace("❌ ","")}):e.jsx(v,{message:z})})]})]})}export{N as default};
